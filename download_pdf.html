<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Download All Participants Predictions</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
            margin: 10px;
            background-color: #1e1e1e;
            color: #7c7a7a;
        }
        .logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .button-container {
            text-align: center;
            margin-top: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border: none;
        }
    </style>
</head>
<body>
    <div class="logo-container">
        <img src="./logos/logo.png" alt="Euro 2024 Logo" style="width:200px;">
    </div>
    <div class="button-container">
        <button onclick="downloadPDF()">Download All Participants Predictions</button>
    </div>

    <script>
        const flags = {
            'Germany': 'https://flagcdn.com/w20/de.png',
            'Scotland': 'https://flagcdn.com/w20/gb-sct.png',
            'Hungary': 'https://flagcdn.com/w20/hu.png',
            'Switzerland': 'https://flagcdn.com/w20/ch.png',
            'Spain': 'https://flagcdn.com/w20/es.png',
            'Croatia': 'https://flagcdn.com/w20/hr.png',
            'Italy': 'https://flagcdn.com/w20/it.png',
            'Albania': 'https://flagcdn.com/w20/al.png',
            'Serbia': 'https://flagcdn.com/w20/rs.png',
            'England': 'https://flagcdn.com/w20/gb-eng.png',
            'Slovenia': 'https://flagcdn.com/w20/si.png',
            'Denmark': 'https://flagcdn.com/w20/dk.png',
            'Poland': 'https://flagcdn.com/w20/pl.png',
            'Netherlands': 'https://flagcdn.com/w20/nl.png',
            'Austria': 'https://flagcdn.com/w20/at.png',
            'France': 'https://flagcdn.com/w20/fr.png',
            'Romania': 'https://flagcdn.com/w20/ro.png',
            'Ukraine': 'https://flagcdn.com/w20/ua.png',
            'Belgium': 'https://flagcdn.com/w20/be.png',
            'Slovakia': 'https://flagcdn.com/w20/sk.png',
            'Turkey': 'https://flagcdn.com/w20/tr.png',
            'Georgia': 'https://flagcdn.com/w20/ge.png',
            'Portugal': 'https://flagcdn.com/w20/pt.png',
            'Czechia': 'https://flagcdn.com/w20/cz.png'
        };

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            // Load the logo image
            const logoResponse = await fetch('./logos/logo.png');
            const logoBlob = await logoResponse.blob();
            const reader = new FileReader();

            reader.onloadend = async function () {
                const logoDataUrl = reader.result;

                // Add the logo image to the first page, centered
                const pageWidth = pdf.internal.pageSize.width;
                const pageHeight = pdf.internal.pageSize.height;
                const logoWidth = 50;
                const logoHeight = 50;
                const logoX = (pageWidth - logoWidth) / 2;
                const logoY = (pageHeight - logoHeight) / 2 - 40; // Adjust Y position to leave space for text

                pdf.addImage(logoDataUrl, 'PNG', logoX, logoY, logoWidth, logoHeight);
                
                pdf.setFontSize(16);
                pdf.text('All Participants Predictions', pageWidth / 2, logoY + logoHeight + 20, { align: 'center' });

                const response = await fetch('./jsons/participants.json');
                const participants = await response.json();

                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text('Participants', pageWidth / 2, logoY + logoHeight + 35, { align: 'center' });
                pdf.setFont(undefined, 'normal');
                pdf.setLineWidth(0.5);
                pdf.line((pageWidth - 30) / 2, logoY + logoHeight + 38, (pageWidth + 30) / 2, logoY + logoHeight + 38); // Underline

                let y = logoY + logoHeight + 45;
                const lineSpacing = 5;
                participants.participants.forEach(participant => {
                    pdf.text(participant.name, pageWidth / 2, y, { align: 'center' });
                    y += lineSpacing;
                });

                // Start a new page for the participant CSV data
                pdf.addPage();

                const boldText = [
                    'Group Stage Predictions', 'Group A', 'Group B', 'Group C', 'Group D', 'Group E', 'Group F', 
                    'Knockout Stage Predictions', 'Round of 16', 'Quarterfinals', 'Semifinals', 'Final', 
                    'Top Goalscorer', 'Best Goalkeeper', 'Player of Tournament', 'Additional Predictions'
                ];

                for (let i = 0; i < participants.participants.length; i++) {
                    const participant = participants.participants[i];
                    const csvResponse = await fetch(participant.file);
                    const csvData = await csvResponse.text();

                    if (i > 0) {
                        pdf.addPage();
                    }

                    pdf.setFontSize(12);
                    pdf.text(participant.name, 10, 10);
                    pdf.setFontSize(8);

                    const rows = csvData.split('\n').map(row => row.split(','));
                    rows.pop(); // Remove the last row
                    let y = 15;
                    const lineHeight = 4;  // Reduce line height further
                    const margin = 5;

                    for (const row of rows) {
                        const line = row.join(', ').trim();
                        if (line) {  // Skip empty rows
                            const splitText = pdf.splitTextToSize(line, pageWidth - margin * 2);

                            for (const textLine of splitText) {
                                if (y + lineHeight > pageHeight - margin) {
                                    pdf.addPage();
                                    y = margin;
                                }
                                const trimmedTextLine = textLine.trim();
                                if (boldText.includes(trimmedTextLine)) {
                                    pdf.setFont(undefined, 'bold');
                                    pdf.text(textLine, margin, y);
                                    pdf.line(margin, y + 1, margin + pdf.getStringUnitWidth(textLine) * 8, y + 1); // Underline
                                    pdf.setFont(undefined, 'normal');
                                } else {
                                    pdf.text(textLine, margin, y);
                                }

                                // Add country flags
                                const countryName = trimmedTextLine.split(' ')[0];
                                if (flags[countryName]) {
                                    const flagResponse = await fetch(flags[countryName]);
                                    const flagBlob = await flagResponse.blob();
                                    const flagReader = new FileReader();
                                    flagReader.onloadend = function () {
                                        const flagDataUrl = flagReader.result;
                                        pdf.addImage(flagDataUrl, 'PNG', margin - 5, y - 3, 5, 3);
                                    };
                                    flagReader.readAsDataURL(flagBlob);
                                }

                                y += lineHeight;
                            }
                        }
                    }
                }

                pdf.save('full_predictions.pdf');
            };

            reader.readAsDataURL(logoBlob);
        }
    </script>
</body>
</html>

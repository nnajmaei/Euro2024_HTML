<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Participant Results vs. Euro2024 Results</title>
    <style>
        body {
            font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
            margin: 10px;
            background-color: #1e1e1e;
            color: #7c7a7a;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            vertical-align: top;
            justify-content: center;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #333333;
        }
        select {
            width: 200px;
            background-color: #6b6a6a;
            color: #fff;
            border: 1px solid #444444;
        }
        .comparison-container {
            display: flex;
            justify-content: space-between;
        }
        .table-container {
            width: 45%;
        }
        .logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .bold-text {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="logo-container">
        <img src="./logos/logo.png" alt="Euro 2024 Logo" style="width:200px;">
    </div>
    <h1>Participant Results vs. Euro2024 Results</h1>
    <div class="comparison-container">
        <div class="table-container">
            <h2>Actual Results</h2>
            <div id="actualResults"></div>
        </div>
        <div class="table-container">
            <h2>Participant Predictions</h2>
            <label for="participantSelect">Select Participant:</label>
            <select id="participantSelect" onchange="loadParticipantPredictions()">
                <option value="">Select...</option>
            </select>
            <div id="participantPredictions"></div>
        </div>
    </div>

    <script>
        const flags = {
            'Germany': 'https://flagcdn.com/w20/de.png',
            'Scotland': 'https://flagcdn.com/w20/gb-sct.png',
            'Hungary': 'https://flagcdn.com/w20/hu.png',
            'Switzerland': 'https://flagcdn.com/w20/ch.png',
            'Spain': 'https://flagcdn.com/w20/es.png',
            'Croatia': 'https://flagcdn.com/w20/hr.png',
            'Italy': 'https://flagcdn.com/w20/it.png',
            'Albania': 'https://flagcdn.com/w20/al.png',
            'Serbia': 'https://flagcdn.com/w20/rs.png',
            'England': 'https://flagcdn.com/w20/gb-eng.png',
            'Slovenia': 'https://flagcdn.com/w20/si.png',
            'Denmark': 'https://flagcdn.com/w20/dk.png',
            'Poland': 'https://flagcdn.com/w20/pl.png',
            'Netherlands': 'https://flagcdn.com/w20/nl.png',
            'Austria': 'https://flagcdn.com/w20/at.png',
            'France': 'https://flagcdn.com/w20/fr.png',
            'Romania': 'https://flagcdn.com/w20/ro.png',
            'Ukraine': 'https://flagcdn.com/w20/ua.png',
            'Belgium': 'https://flagcdn.com/w20/be.png',
            'Slovakia': 'https://flagcdn.com/w20/sk.png',
            'Turkey': 'https://flagcdn.com/w20/tr.png',
            'Georgia': 'https://flagcdn.com/w20/ge.png',
            'Portugal': 'https://flagcdn.com/w20/pt.png',
            'Czechia': 'https://flagcdn.com/w20/cz.png'
        };

        function loadCSV(file, callback) {
            fetch(file)
                .then(response => response.text())
                .then(data => {
                    const rows = data.split('\n').map(row => row.split(','));
                    callback(rows);
                })
                .catch(error => console.error('Error loading CSV:', error));
        }

        function populateDropdowns(participants) {
            const participantSelect = document.getElementById('participantSelect');
            participants.forEach(participant => {
                const option = document.createElement('option');
                option.value = participant.file;
                option.text = participant.name;
                participantSelect.add(option);
            });
        }

        function displayTable(containerId, rows) {
            const boldText = [
                'Group Stage Predictions', 'Group A', 'Group B', 'Group C', 'Group D', 'Group E', 'Group F', 
                'Knockout Stage Predictions', 'Round of 16', 'Quarterfinals', 'Semifinals', 'Final', 
                'Top Goalscorer', 'Best Goalkeeper', 'Player of Tournament'
            ];

            let tableHTML = '<table>';
            rows.forEach(row => {
                tableHTML += '<tr>';
                row.forEach(cell => {
                    const cellContent = cell.trim();
                    const flagImg = flags[cellContent] ? `<img src="${flags[cellContent]}" class="flag"> ` : '';
                    const cellClass = boldText.includes(cellContent) ? 'bold-text' : '';
                    tableHTML += `<td class="${cellClass}">${flagImg}${cellContent}</td>`;
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</table>';
            document.getElementById(containerId).innerHTML = tableHTML;
        }

        function loadParticipantPredictions() {
            const participantSelect = document.getElementById('participantSelect');
            const selectedFile = participantSelect.value;
            if (selectedFile) {
                loadCSV(selectedFile, rows => displayTable('participantPredictions', rows));
            } else {
                document.getElementById('participantPredictions').innerHTML = '';
            }
        }

        function calculateScores(actualResults, participantPredictions) {
            const scores = {};
            actualResults.forEach((actualResult) => {
                const [date, team1, team1Score, team2, team2Score] = actualResult;
                scores[`${date} ${team1} vs ${team2}`] = {};

                participantPredictions.forEach((participant) => {
                    const participantName = participant.name;
                    const participantFile = participant.file;
                    loadCSV(participantFile, (rows) => {
                        rows.forEach((row) => {
                            if (row.includes(team1) && row.includes(team2)) {
                                const team1Index = row.indexOf(team1);
                                const team2Index = row.indexOf(team2);
                                const predictedScore1 = parseInt(row[team1Index + 1]);
                                const predictedScore2 = parseInt(row[team2Index + 1]);
                                const actualScore1 = parseInt(team1Score);
                                const actualScore2 = parseInt(team2Score);

                                let score = 0;
                                if (predictedScore1 === actualScore1 && predictedScore2 === actualScore2) {
                                    score = 10;
                                } else if ((actualScore1 - actualScore2 === predictedScore1 - predictedScore2) && (actualScore1 > actualScore2 && predictedScore1 > predictedScore2 || actualScore1 < actualScore2 && predictedScore1 < predictedScore2)) {
                                    score = 8;
                                } else if (actualScore1 === actualScore2 && predictedScore1 === predictedScore2) {
                                    score = 5;
                                } else if ((actualScore1 > actualScore2 && predictedScore1 > predictedScore2) || (actualScore1 < actualScore2 && predictedScore1 < predictedScore2)) {
                                    score = 5;
                                }

                                scores[`${date} ${team1} vs ${team2}`][participantName] = score;
                            }
                        });
                    });
                });
            });

            return scores;
        }

        function createResultsCSV(scores) {
            let csvContent = "data:text/csv;charset=utf-8,Date,Team1,Team2";
            const participantNames = Object.keys(scores[Object.keys(scores)[0]]);
            participantNames.forEach(name => {
                csvContent += `,${name}`;
            });
            csvContent += "\n";

            for (const match in scores) {
                const [date, team1VsTeam2] = match.split(" ");
                const [team1, team2] = team1VsTeam2.split(" vs ");
                csvContent += `${date},${team1},${team2}`;
                participantNames.forEach(name => {
                    csvContent += `,${scores[match][name]}`;
                });
                csvContent += "\n";
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "participant_scores.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Load actual results on page load
        window.onload = function() {
            loadCSV('./results_csv/Actual_Results.csv', rows => {
                displayTable('actualResults', rows);

                fetch('./jsons/participants.json')
                    .then(response => response.json())
                    .then(data => {
                        populateDropdowns(data.participants);

                        const scores = calculateScores(rows, data.participants);
                        createResultsCSV(scores);
                    })
                    .catch(error => console.error('Error loading participants list:', error));
            });
        };
    </script>
</body>
</html>
